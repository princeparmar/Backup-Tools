name: Deploy to Staging

on:
  push:
    branches:
      - main
  workflow_dispatch: # Manual trigger

env:
  APP_NAME: 'backuptools-windows-amd64.exe'
  DEPLOY_DIR: 'D:\bin'
  SERVICE_NAME: 'backuptools'

jobs:
  build-and-deploy:
    runs-on: [self-hosted, Windows, X64, staging]
    timeout-minutes: 8
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          
      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21.13'
          cache: true
          
      - name: Build application
        run: |
          $buildTime = Get-Date -Format 'yyyy-MM-dd_HH:mm:ss'
          go build -o ${{ env.APP_NAME }} -ldflags="-s -w -X main.buildTime=$buildTime" -trimpath ./cmd
          
      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: backuptools-binary
          path: ${{ env.APP_NAME }}
          retention-days: 1
          
      - name: Stop and deploy
        run: |
          # Stop existing process
          Get-Process -Name "${{ env.APP_NAME }}" -ErrorAction SilentlyContinue | Stop-Process -Force
          Start-Sleep -Seconds 2
          
          # Ensure directory exists
          if (!(Test-Path "${{ env.DEPLOY_DIR }}")) {
            New-Item -ItemType Directory -Path "${{ env.DEPLOY_DIR }}" -Force
          }
          
          # Deploy
          Copy-Item "${{ env.APP_NAME }}" "${{ env.DEPLOY_DIR }}\" -Force
          Write-Host "Deployed to ${{ env.DEPLOY_DIR }}"
          
      - name: Start application
        run: |
          Start-Process "${{ env.DEPLOY_DIR }}\${{ env.APP_NAME }}" -WorkingDirectory "${{ env.DEPLOY_DIR }}"
          Write-Host "Application started"
          
      - name: Verify deployment
        run: |
          Start-Sleep -Seconds 3
          $process = Get-Process -Name "${{ env.APP_NAME }}" -ErrorAction SilentlyContinue
          if ($process) {
            Write-Host "✅ Staging deployment successful - PID: $($process.Id)"
          } else {
            Write-Host "❌ Staging deployment failed"
            exit 1
          }
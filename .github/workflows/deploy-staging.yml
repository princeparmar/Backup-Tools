name: Deploy to Staging

on:
  push:
    branches:
      - main
  workflow_dispatch: # Manual trigger

env:
  APP_NAME: 'backuptools-windows-amd64.exe'
  BUILD_DIR: 'D:\deployment'
  DEPLOY_DIR: 'D:\bin'
  SERVICE_NAME: 'backuptools'

jobs:
  build-and-deploy:
    runs-on: [self-hosted, Windows, X64, staging]
    timeout-minutes: 8
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          
      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21.13'
          cache: true
          
      - name: Build application in deployment directory
        run: |
          # Ensure build directory exists
          if (!(Test-Path "${{ env.BUILD_DIR }}")) {
            New-Item -ItemType Directory -Path "${{ env.BUILD_DIR }}" -Force
          }
          
          # Build binary in D:\deployment
          $buildTime = Get-Date -Format 'yyyy-MM-dd_HH:mm:ss'
          $buildPath = Join-Path "${{ env.BUILD_DIR }}" "${{ env.APP_NAME }}"
          go build -o $buildPath -ldflags="-s -w -X main.buildTime=$buildTime" -trimpath ./cmd
          Write-Host "✅ Binary built at: $buildPath"
          
      - name: Stop NSSM service
        run: |
          # Stop NSSM service named 'backuptools'
          $service = Get-Service -Name "${{ env.SERVICE_NAME }}" -ErrorAction SilentlyContinue
          if ($service) {
            if ($service.Status -eq 'Running') {
              Stop-Service -Name "${{ env.SERVICE_NAME }}" -Force
              Write-Host "NSSM service '${{ env.SERVICE_NAME }}' stopped"
              
              # Wait for service to fully stop and release file lock
              $timeout = 10
              $elapsed = 0
              while ($service.Status -ne 'Stopped' -and $elapsed -lt $timeout) {
                Start-Sleep -Seconds 1
                $service.Refresh()
                $elapsed++
              }
              
              if ($service.Status -eq 'Stopped') {
                Write-Host "Service fully stopped"
              } else {
                Write-Host "Warning: Service may still be stopping"
              }
            } else {
              Write-Host "Service '${{ env.SERVICE_NAME }}' is already stopped"
            }
          } else {
            Write-Host "Service '${{ env.SERVICE_NAME }}' not found (may not be installed)"
          }
          
      - name: Deploy new version
        run: |
          # Ensure deploy directory exists
          if (!(Test-Path "${{ env.DEPLOY_DIR }}")) {
            New-Item -ItemType Directory -Path "${{ env.DEPLOY_DIR }}" -Force
          }
          
          # Copy from build directory to deploy directory
          $buildPath = Join-Path "${{ env.BUILD_DIR }}" "${{ env.APP_NAME }}"
          $deployPath = Join-Path "${{ env.DEPLOY_DIR }}" "${{ env.APP_NAME }}"
          
          if (Test-Path $buildPath) {
            Copy-Item $buildPath $deployPath -Force
            Write-Host "✅ Deployed from $buildPath to $deployPath"
          } else {
            Write-Host "❌ Build file not found at: $buildPath"
            exit 1
          }
          
      - name: Start NSSM service
        run: |
          # Start the NSSM service
          $service = Get-Service -Name "${{ env.SERVICE_NAME }}" -ErrorAction SilentlyContinue
          if ($service) {
            Start-Service -Name "${{ env.SERVICE_NAME }}"
            Write-Host "NSSM service '${{ env.SERVICE_NAME }}' started"
          } else {
            Write-Host "❌ Service '${{ env.SERVICE_NAME }}' not found - cannot start"
            exit 1
          }
          
      - name: Verify deployment
        run: |
          Start-Sleep -Seconds 3
          # Check if service is running
          $service = Get-Service -Name "${{ env.SERVICE_NAME }}" -ErrorAction SilentlyContinue
          if ($service -and $service.Status -eq 'Running') {
            Write-Host "✅ Staging deployment successful - Service is running"
          } else {
            Write-Host "❌ Staging deployment failed - Service is not running"
            exit 1
          }